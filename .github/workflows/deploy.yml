name: Deploy Lambda

run-name: ${{ github.event_name == 'workflow_run' && format('Deploy [{0}] to DEV - {1}', github.ref_name, github.sha) || format('Deploy [release] to {0} - {1}', inputs.environment, inputs.release-tag) }}

on:
  workflow_run:
    workflows: ["Build"]
    types:
      - completed

  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        required: true
        type: environment
      release-tag:
        description: Release tag to deploy (e.g., 1.0.0)
        required: true
        type: string

jobs:
  deploy-main:
    if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' }}
    uses: kvncont/gh-workflows/.github/workflows/aws-lambda-cd.yml@main
    with:
      environment: DEV
      artifact-source: github
      artifact-name: lambda-${{ github.sha }}
      zip-file: lambda-${{ github.sha }}.zip
      run-id: ${{ github.event.workflow_run.id }}
      version-description: "Deploy [${{ github.ref_name }}]: ${{ github.sha }}"
    secrets:
      aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  deploy-release:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    uses: kvncont/gh-workflows/.github/workflows/aws-lambda-cd.yml@main
    with:
      environment: ${{ inputs.environment }}
      artifact-source: s3
      s3-prefix: releases/${{ inputs.environment }}/${{ github.event.repository.name }}/${{ inputs.release-tag }}
      zip-file: lambda-${{ inputs.release-tag }}.zip
      version-description: "Deploy [release]: ${{ inputs.release-tag }}"
    secrets:
      aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}